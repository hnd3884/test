package com.me.devicemanagement.framework.server.admin;

import java.util.Hashtable;
import java.util.List;
import java.util.ArrayList;
import com.adventnet.persistence.DataAccess;
import com.adventnet.ds.query.Join;
import com.adventnet.ds.query.SelectQuery;
import com.adventnet.ds.query.SelectQueryImpl;
import com.adventnet.ds.query.Table;
import com.adventnet.persistence.DataAccessException;
import com.me.devicemanagement.framework.server.exception.SyMException;
import com.me.devicemanagement.framework.server.logger.seconelinelogger.SecurityOneLineLogger;
import java.util.logging.Level;
import com.adventnet.persistence.Row;
import com.me.devicemanagement.framework.server.authentication.DMUserHandler;
import org.json.simple.JSONObject;
import com.me.devicemanagement.framework.server.util.SyMUtil;
import com.adventnet.ds.query.Criteria;
import com.adventnet.ds.query.Column;
import com.adventnet.persistence.DataObject;
import java.util.Properties;
import java.util.UUID;
import java.util.logging.Logger;

public abstract class AuthenticationKeyHandler
{
    private static Logger logger;
    
    public String generateTechAPIKey() {
        return UUID.randomUUID().toString().toUpperCase();
    }
    
    public DataObject addOrUpdateAPIKey(final Properties props) throws SyMException, DataAccessException {
        DataObject techDefDO = null;
        final String login_id = props.getProperty("loginID");
        final String apiKey = props.getProperty("apiKey");
        final String scope = props.getProperty("SCOPE", "desktopcentral.admin.helpdeskserver.sdp_dc_integ");
        final Integer serviceType = Integer.parseInt(props.getProperty("SERVICE_TYPE"));
        Criteria crit = new Criteria(Column.getColumn("APIKeyDetails", "LOGIN_ID"), (Object)Long.valueOf(login_id), 0);
        crit = crit.and(new Criteria(Column.getColumn("APIKeyDetails", "SERVICE_TYPE"), (Object)serviceType, 0));
        techDefDO = SyMUtil.getPersistence().get("APIKeyDetails", crit);
        final JSONObject jsonObject = new JSONObject();
        final String userName = DMUserHandler.getUserName(Long.parseLong(login_id));
        if (techDefDO.isEmpty()) {
            final Row row = new Row("APIKeyDetails");
            row.set("LOGIN_ID", (Object)login_id);
            row.set("APIKEY", (Object)this.getEncryptedAuthToken(apiKey, serviceType));
            row.set("CREATEDTIME", (Object)System.currentTimeMillis());
            row.set("SCOPE", (Object)scope);
            row.set("SERVICE_TYPE", (Object)serviceType);
            techDefDO.addRow(row);
            SyMUtil.getPersistence().add(techDefDO);
            jsonObject.put((Object)"REMARK", (Object)"API Key has been generated by ".concat(userName));
        }
        else {
            final Row row = techDefDO.getRow("APIKeyDetails");
            row.set("APIKEY", (Object)this.getEncryptedAuthToken(apiKey, serviceType));
            row.set("CREATEDTIME", (Object)System.currentTimeMillis());
            row.set("SCOPE", (Object)scope);
            row.set("SERVICE_TYPE", (Object)serviceType);
            techDefDO.updateRow(row);
            SyMUtil.getPersistence().update(techDefDO);
            jsonObject.put((Object)"REMARK", (Object)"API Key has been regenerated by ".concat(userName));
        }
        APIKeyGeneratorHandler.getInstance().invokeAPIKeyAddOrUpdateListeners(scope);
        SecurityOneLineLogger.log("DC_Integration", "DC_API_Key_Generation", jsonObject, Level.INFO);
        return techDefDO;
    }
    
    public String getOrAddAuthToken(final Properties prop) throws DataAccessException, SyMException {
        final Long loginId = Long.parseLong(prop.getProperty("loginID"));
        final Integer serviceType = Integer.parseInt(prop.getProperty("SERVICE_TYPE"));
        final SelectQuery sQuery = (SelectQuery)new SelectQueryImpl(new Table("APIKeyDetails"));
        final Criteria loginCriteria = new Criteria(new Column("APIKeyDetails", "LOGIN_ID"), (Object)loginId, 0);
        final Criteria serviceTypeCriteria = new Criteria(new Column("APIKeyDetails", "SERVICE_TYPE"), (Object)serviceType, 0);
        sQuery.setCriteria(loginCriteria.and(serviceTypeCriteria));
        sQuery.addSelectColumn(new Column((String)null, "*"));
        final DataObject dO = SyMUtil.getPersistence().get(sQuery);
        if (!dO.isEmpty()) {
            final Row row = dO.getFirstRow("APIKeyDetails");
            final String encryptedAuthToken = (String)row.get("APIKEY");
            return this.getDecryptedAuthToken(encryptedAuthToken, serviceType);
        }
        final String authToken = this.generateTechAPIKey();
        ((Hashtable<String, String>)prop).put("apiKey", authToken);
        this.addOrUpdateAPIKey(prop);
        return authToken;
    }
    
    protected abstract String getDecryptedAuthToken(final String p0, final Integer p1) throws SyMException;
    
    protected abstract String getEncryptedAuthToken(final String p0, final Integer p1) throws SyMException;
    
    public DataObject authenticateAPIKey(String authKey, final Integer serviceType) {
        DataObject keyTableDO = null;
        try {
            if (authKey == null || "".equals(authKey) || "null".equalsIgnoreCase(authKey)) {
                AuthenticationKeyHandler.logger.log(Level.INFO, "Authentication key is null or empty. Unable to authenticate.");
                return null;
            }
            authKey = this.getEncryptedAuthToken(authKey, serviceType);
            keyTableDO = this.getAPIKeyLoginInfo(authKey);
            if (keyTableDO != null && !keyTableDO.isEmpty()) {
                try {
                    final Row techRow = keyTableDO.getFirstRow("APIKeyDetails");
                    final String keyStatus = (String)techRow.get("STATUS");
                    final String authKeyInDO = (String)techRow.get("APIKEY");
                    if (keyStatus.equalsIgnoreCase("active")) {
                        final Long validity = (Long)techRow.get("VALIDITY");
                        if (validity > System.currentTimeMillis() || validity == -1L) {
                            return keyTableDO;
                        }
                    }
                    else {
                        AuthenticationKeyHandler.logger.log(Level.INFO, "Key " + authKeyInDO + " received is not active. Cannot perform operation");
                    }
                    return keyTableDO;
                }
                catch (final Exception ex) {
                    AuthenticationKeyHandler.logger.log(Level.SEVERE, "Exception when trying to get user info from DO or when updating API key info - " + ex.getMessage(), ex);
                    throw ex;
                }
            }
            AuthenticationKeyHandler.logger.log(Level.INFO, "Key not present for any user - auth fail - return false");
        }
        catch (final Exception exp) {
            AuthenticationKeyHandler.logger.log(Level.WARNING, "Exception while authenticationg user");
        }
        return keyTableDO;
    }
    
    private DataObject getAPIKeyLoginInfo(final String encryptedKey) throws Exception {
        DataObject infoDO = null;
        try {
            final SelectQueryImpl sql = new SelectQueryImpl(Table.getTable("APIKeyDetails"));
            final String[] joinCol1 = { "LOGIN_ID" };
            final String[] joinCol2 = { "LOGIN_ID" };
            final Join sqlJoin = new Join("APIKeyDetails", "AaaLogin", joinCol1, joinCol2, 1);
            sql.addJoin(sqlJoin);
            sql.addSelectColumn(Column.getColumn("APIKeyDetails", "*"));
            sql.addSelectColumn(Column.getColumn("AaaLogin", "*"));
            final DataObject returnDO = DataAccess.get((SelectQuery)sql);
            final ArrayList<String> tableNames = new ArrayList<String>(2);
            tableNames.add("APIKeyDetails");
            tableNames.add("AaaLogin");
            final Criteria crit = new Criteria(Column.getColumn("APIKeyDetails", "APIKEY"), (Object)encryptedKey, 0);
            final Row inputRow = returnDO.getRow("APIKeyDetails", crit);
            if (inputRow != null) {
                infoDO = returnDO.getDataObject((List)tableNames, inputRow);
            }
        }
        catch (final Exception e) {
            AuthenticationKeyHandler.logger.log(Level.SEVERE, "Exception when getting user info for Key", e);
            throw e;
        }
        return infoDO;
    }
    
    static {
        AuthenticationKeyHandler.logger = Logger.getLogger(AuthenticationKeyHandler.class.getName());
    }
}
